<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Leaflet 0.9.0（写真管理統合版）</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css">

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

  <!-- EXIF.js -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

  <!-- Pannellum -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.css">
  <script src="https://cdn.jsdelivr.net/npm/pannellum/build/pannellum.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }

    #header {
      padding: 8px 12px;
      background: #2c3e50;
      color: #ecf0f1;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #header input {
      padding: 4px;
      width: 220px;
    }

    #header button {
      padding: 4px 8px;
    }

    #container {
      display: flex;
      height: calc(100vh - 40px);
    }

    #sidebar {
      width: 300px;
      background: #f4f4f4;
      border-right: 1px solid #ccc;
      padding: 0;
      overflow-y: auto;
      position: relative;
    }

    /* タブ */
    .tab-buttons {
      display: flex;
      background: #ddd;
      border-bottom: 1px solid #aaa;
    }

    .tab-buttons div {
      flex: 1;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      border-right: 1px solid #aaa;
    }

    .tab-buttons div:last-child {
      border-right: none;
    }

    .tab-buttons div.active {
      background: #fff;
    }

    .tab-content {
      display: none;
      padding: 10px;
    }

    .tab-content.active {
      display: block;
    }

    /* 属性テーブル */
    .attr-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .attr-table td {
      border: 1px solid #ccc;
      padding: 4px;
      background: #fff;
    }

    /* 写真カード */
    .card {
      margin-bottom: 12px;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 4px;
      background: #fff;
      position: relative;
      cursor: pointer;
    }

    .thumb {
      width: 100%;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    #map {
      flex: 1;
      width: 100%;
      height: 100%;
      position: relative;
    }

    #coordBox {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      z-index: 1000;
    }

    .pano-box {
      width: 300px;
      height: 200px;
    }

    .crosshair-icon {
      color: red;
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      line-height: 20px;
    }

    /* スマホ最適化（幅600px以下） */
    @media (max-width: 600px) {
      #sidebar {
        width: 0 !important;
        padding: 0 !important;
      }

      #header input {
        width: 120px;
      }

      .leaflet-control-minimap {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <div id="header">
    Leaflet 0.9.0（写真管理統合版）
    <input type="text" id="searchBox" placeholder="地名または座標を入力">
    <button id="searchBtn">検索</button>
    <button id="locateBtn">現在地</button>
  </div>

  <div id="container">

    <!-- サイドバー -->
    <div id="sidebar">

      <!-- タブボタン -->
      <div class="tab-buttons">
        <div id="tabAttr" class="active">属性情報</div>
        <div id="tabPhoto">写真管理</div>
      </div>

      <!-- 属性情報タブ -->
      <div id="attrPanel" class="tab-content active">
        <h3>属性情報</h3>
        <div id="attrContent">地物をクリックしてください。</div>
      </div>

      <!-- 写真管理タブ -->
      <div id="photoPanel" class="tab-content">
        <h3>写真管理</h3>
        <input type="file" id="photoInput" accept="image/jpeg" multiple><br><br>
        <div id="photoList"></div>
      </div>

    </div>

    <!-- 地図 -->
    <div id="map">
      <div id="coordBox">Lat: ---, Lng: ---</div>
    </div>

  </div>

  <script>
    /* ===== タブ切り替え ===== */
    const tabAttr = document.getElementById("tabAttr");
    const tabPhoto = document.getElementById("tabPhoto");
    const attrPanel = document.getElementById("attrPanel");
    const photoPanel = document.getElementById("photoPanel");

    tabAttr.onclick = () => {
      tabAttr.classList.add("active");
      tabPhoto.classList.remove("active");
      attrPanel.classList.add("active");
      photoPanel.classList.remove("active");
    };

    tabPhoto.onclick = () => {
      tabPhoto.classList.add("active");
      tabAttr.classList.remove("active");
      photoPanel.classList.add("active");
      attrPanel.classList.remove("active");
    };

    /* ===== 初期表示レイヤ ===== */
    const layerGSIstd = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
      { attribution: "地理院タイル（標準）" }
    );

    const map = L.map("map", {
      center: [37.303254, 136.915478],
      zoom: 14,
      layers: [layerGSIstd]
    });

    /* ===== ベースレイヤー ===== */
    const layerOSM = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: "© OpenStreetMap contributors" }
    );

    const layerGSIort = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg",
      { attribution: "地理院タイル（空中写真）" }
    );

    const baseLayers = {
      "地理院地図（標準）": layerGSIstd,
      "OpenStreetMap": layerOSM,
      "地理院空中写真": layerGSIort
    };

    L.control.layers(baseLayers).addTo(map);

    /* ===== MiniMap ===== */
    const miniLayer = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: "" }
    );

    new L.Control.MiniMap(miniLayer, {
      position: "bottomright",
      toggleDisplay: true,
      minimized: false,
      width: 150,
      height: 150,
      zoomLevelOffset: -5
    }).addTo(map);

    /* ===== 属性ビューア（ダミー） ===== */
    const dummyGeoJSON = {
      type: "FeatureCollection",
      features: [
        {
          type: "Feature",
          properties: {
            name: "サンプル地点",
            desc: "ここに説明文が入ります。",
            area: "不明"
          },
          geometry: {
            type: "Point",
            coordinates: [136.915478, 37.303254]
          }
        }
      ]
    };

    L.geoJSON(dummyGeoJSON, {
      onEachFeature: (feature, layer) => {
        layer.on("click", () => {
          let html = "<table class='attr-table'>";
          for (let key in feature.properties) {
            html += `<tr><td><b>${key}</b></td><td>${feature.properties[key]}</td></tr>`;
          }
          html += "</table>";
          document.getElementById("attrContent").innerHTML = html;
        });
      }
    }).addTo(map);

    /* ===== 十字線マーカー ===== */
    const crosshairIcon = L.divIcon({
      className: "crosshair-icon",
      html: "+",
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    const centerMarker = L.marker(map.getCenter(), {
      icon: crosshairIcon,
      interactive: false
    }).addTo(map);

    function updateCenterInfo() {
      const c = map.getCenter();
      centerMarker.setLatLng(c);
      document.getElementById("coordBox").textContent =
        `Lat: ${c.lat.toFixed(6)} , Lng: ${c.lng.toFixed(6)}`;
    }

    map.on("move", updateCenterInfo);
    updateCenterInfo();

    /* ===== 検索 ===== */
    function isLatLng(text) {
      const parts = text.split(",");
      return parts.length === 2 &&
        !isNaN(parseFloat(parts[0])) &&
        !isNaN(parseFloat(parts[1]));
    }

    function moveToLatLng(lat, lng) {
      map.setView([lat, lng], 15);
    }

    function searchPlace(query) {
      const url =
        "https://nominatim.openstreetmap.org/search?format=json&q=" +
        encodeURIComponent(query);

      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.length === 0) {
            alert("場所が見つかりませんでした");
            return;
          }
          moveToLatLng(parseFloat(data[0].lat), parseFloat(data[0].lon));
        });
    }

    document.getElementById("searchBtn").onclick = () => {
      const text = document.getElementById("searchBox").value.trim();
      if (text === "") return;

      if (isLatLng(text)) {
        const p = text.split(",");
        moveToLatLng(parseFloat(p[0]), parseFloat(p[1]));
      } else {
        searchPlace(text);
      }
    };

    /* ===== 現在地ボタン ===== */
    document.getElementById("locateBtn").onclick = () => {
      map.locate({ setView: true, maxZoom: 16 });
    };

    map.on("locationerror", () => {
      alert("現在地を取得できませんでした（HTTPS が必要です）");
    });

    /* ===== 写真管理機能一式 ===== */

    const photoDataList = [];

    /* 360°判定（2:1 比率判定） */
    function detect360(imgURL, callback) {
      const img = new Image();
      img.onload = () => {
        const ratio = img.width / img.height;
        callback(Math.abs(ratio - 2.0) < 0.05); // 2:1 判定
      };
      img.src = imgURL;
    }

    /* 写真入力 */
    document.getElementById("photoInput").onchange = function(e) {
      const files = e.target.files;

      for (let file of files) {
        EXIF.getData(file, function() {
          const lat = EXIF.getTag(this, "GPSLatitude");
          const lng = EXIF.getTag(this, "GPSLongitude");
          const dateTime = EXIF.getTag(this, "DateTimeOriginal");

          if (!lat || !lng) {
            alert(file.name + " にはGPS位置情報がありません。");
            return;
          }

          function toDecimal(dms) {
            return dms[0] + dms[1] / 60 + dms[2] / 3600;
          }

          const latDec = toDecimal(lat);
          const lngDec = toDecimal(lng);

          const imgURL = URL.createObjectURL(file);
          const fileName = file.name;
          const shotTime = dateTime ? dateTime : "不明";

          const index = photoDataList.length;

          detect360(imgURL, (is360) => {

            let popupHTML = "";

            if (is360) {
              popupHTML = `
                <div class="pano-box" id="pano_${index}"></div>
                <div style="font-size:12px; margin-top:4px;">
                  <b>${fileName}</b><br>
                  Lat: ${latDec.toFixed(6)}<br>
                  Lng: ${lngDec.toFixed(6)}
                </div>
              `;
            } else {
              popupHTML = `
                <div style="text-align:center;">
                  <img src="${imgURL}" width="200"><br>
                  <b>${fileName}</b><br>
                  Lat: ${latDec.toFixed(6)}<br>
                  Lng: ${lngDec.toFixed(6)}
                </div>
              `;
            }

            const marker = L.marker([latDec, lngDec]).addTo(map);
            marker.bindPopup(popupHTML);

            marker.on("popupopen", () => {
              if (is360) {
                setTimeout(() => {
                  pannellum.viewer(`pano_${index}`, {
                    type: "equirectangular",
                    panorama: imgURL,
                    autoLoad: true,
                    showFullscreenCtrl: true
                  });
                }, 50);
              }
            });

            const data = {
              lat: latDec,
              lng: lngDec,
              fileName,
              imgURL,
              marker,
              shotTime,
              is360
            };

            photoDataList.push(data);
            addThumbnail(index);
          });
        });
      }
    };

    /* カード（サムネイル＋情報＋削除） */
    function addThumbnail(index) {
      const data = photoDataList[index];
      const list = document.getElementById("photoList");

      const item = document.createElement("div");
      item.className = "card";

      const img = document.createElement("img");
      img.src = data.imgURL;
      img.className = "thumb";

      const name = document.createElement("div");
      name.textContent = data.fileName;
      name.style.fontSize = "12px";
      name.style.wordBreak = "break-all";

      const time = document.createElement("div");
      time.textContent = "撮影日時: " + data.shotTime;
      time.style.fontSize = "11px";

      const latlng = document.createElement("div");
      latlng.textContent = `Lat: ${data.lat.toFixed(6)} / Lng: ${data.lng.toFixed(6)}`;
      latlng.style.fontSize = "11px";

      if (data.is360) {
        const tag360 = document.createElement("div");
        tag360.textContent = "360°";
        tag360.style.position = "absolute";
        tag360.style.top = "4px";
        tag360.style.left = "6px";
        tag360.style.background = "#007bff";
        tag360.style.color = "#fff";
        tag360.style.fontSize = "10px";
        tag360.style.padding = "2px 4px";
        tag360.style.borderRadius = "3px";
        item.appendChild(tag360);
      }

      const delBtn = document.createElement("div");
      delBtn.textContent = "×";
      delBtn.style.position = "absolute";
      delBtn.style.top = "4px";
      delBtn.style.right = "6px";
      delBtn.style.cursor = "pointer";
      delBtn.style.color = "#c00";
      delBtn.style.fontWeight = "bold";
      delBtn.style.fontSize = "16px";

      delBtn.onclick = (event) => {
        event.stopPropagation();
        map.removeLayer(data.marker);
        photoDataList.splice(index, 1);
        list.removeChild(item);
        refreshThumbnailIndexes();
      };

      item.onclick = () => {
        map.setView([data.lat, data.lng], 16);
        data.marker.openPopup();
      };

      item.appendChild(img);
      item.appendChild(name);
      item.appendChild(time);
      item.appendChild(latlng);
      item.appendChild(delBtn);
      list.appendChild(item);
    }

    function refreshThumbnailIndexes() {
      const list = document.getElementById("photoList");
      list.innerHTML = "";
      photoDataList.forEach((_, i) => addThumbnail(i));
    }
  </script>

</body>
</html>