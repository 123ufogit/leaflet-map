<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>GeoTIFF Viewer (georaster)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

<!-- georaster & georaster-layer-for-leaflet -->
<script src="https://unpkg.com/georaster"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>

<style>
  body, html {
    margin: 0;
    height: 100%;
    overflow: hidden;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  #dropzone {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border: 2px dashed #666;
    border-radius: 6px;
    z-index: 1000;
  }
</style>
</head>

<body>

<div id="dropzone">
  <div>GeoTIFF を選択 or ドラッグ＆ドロップ</div>
  <input type="file" id="fileInput" accept=".tif,.tiff" />
</div>

<div id="map"></div>

<script>
// ------------------------------
// Leaflet マップ初期化
// ------------------------------
const map = L.map("map", {
  center: [37.0, 137.0],
  zoom: 5
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap contributors"
}).addTo(map);

let currentLayer = null;

// ------------------------------
// GeoTIFF を読み込んで表示する関数
// ------------------------------
async function loadGeoTIFF(arrayBuffer) {
  const georaster = await parseGeoraster(arrayBuffer);

  if (currentLayer) {
    map.removeLayer(currentLayer);
  }

  currentLayer = new GeoRasterLayer({
    georaster,
    opacity: 0.8
  });

  currentLayer.addTo(map);
  map.fitBounds(currentLayer.getBounds());
}

// ------------------------------
// ファイル選択で読み込み
// ------------------------------
document.getElementById("fileInput").addEventListener("change", async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  loadGeoTIFF(arrayBuffer);
});

// ------------------------------
// ドラッグ＆ドロップ対応
// ------------------------------
const dropzone = document.getElementById("dropzone");

dropzone.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropzone.style.background = "rgba(200,255,200,0.9)";
});

dropzone.addEventListener("dragleave", () => {
  dropzone.style.background = "rgba(255,255,255,0.9)";
});

dropzone.addEventListener("drop", async (e) => {
  e.preventDefault();
  dropzone.style.background = "rgba(255,255,255,0.9)";

  const file = e.dataTransfer.files[0];
  if (!file) return;

  const arrayBuffer = await file.arrayBuffer();
  loadGeoTIFF(arrayBuffer);
});
</script>

</body>
</html>
