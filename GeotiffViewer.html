<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>GeoTIFF ビューワー＋作図ツール（geotiff.js版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- easyPrint -->
  <script src="https://unpkg.com/leaflet-easyprint@2.1.9/dist/bundle.js"></script>

  <!-- geotiff.js（公式 CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/geotiff/dist/geotiff.bundle.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #map { height: 100%; width: 100%; }
    #dropzone {
      position: absolute; top: 10px; right: 10px;
      z-index: 1000; background: rgba(0,0,0,0.6);
      color: #fff; padding: 8px 12px; border-radius: 4px;
      font-size: 12px; pointer-events: none;
    }
    #dropzone.dragover { background: rgba(0,120,215,0.8); }
    #drop-overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; z-index: 999;
      pointer-events: none; background: transparent;
    }
    #toolbar {
      position: absolute; top: 10px; left: 10px;
      z-index: 1001; background: rgba(255,255,255,0.9);
      padding: 6px 10px; border-radius: 4px;
      font-size: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <div id="map"></div>
  <div id="dropzone">ここに GeoTIFF をドラッグ＆ドロップ</div>
  <div id="drop-overlay"></div>

  <div id="toolbar">
    <strong>操作:</strong> 左上のプリンタアイコンから印刷できます
  </div>

<script>
/* =========================
   1. Leaflet マップ初期化
   ========================= */
const map = L.map("map", {
  center: [36.56, 136.65],
  zoom: 13,
  zoomControl: true,
});

const gsiStd = L.tileLayer(
  "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
  { maxZoom: 18, attribution: "地理院タイル" }
).addTo(map);

const gsiOrt = L.tileLayer(
  "https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg",
  { maxZoom: 18, attribution: "地理院タイル（オルソ画像）" }
);

const baseLayers = {
  "標準地図": gsiStd,
  "航空写真": gsiOrt,
};

const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

let geotiffLayer = null;

const overlays = { "作図レイヤ": drawnItems };
const layerControl = L.control.layers(baseLayers, overlays).addTo(map);

/* =========================
   2. Leaflet.draw
   ========================= */
const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems, remove: true },
  draw: {
    polygon: { allowIntersection: false, showArea: true },
    polyline: true,
    rectangle: true,
    marker: true,
    circle: false,
    circlemarker: false,
  },
});
map.addControl(drawControl);

map.on(L.Draw.Event.CREATED, (e) => {
  drawnItems.addLayer(e.layer);
});

/* =========================
   3. easyPrint
   ========================= */
L.easyPrint({
  title: "印刷 / 保存",
  position: "topleft",
  sizeModes: ["Current", "A4Portrait", "A4Landscape"],
}).addTo(map);

/* =========================
   4. ドラッグ＆ドロップ
   ========================= */
const dropzone = document.getElementById("dropzone");
const dropOverlay = document.getElementById("drop-overlay");

["dragenter", "dragover"].forEach((eventName) => {
  window.addEventListener(eventName, (e) => {
    e.preventDefault();
    dropOverlay.style.pointerEvents = "auto";
    dropzone.classList.add("dragover");
  });
});

["dragleave", "drop"].forEach((eventName) => {
  window.addEventListener(eventName, (e) => {
    e.preventDefault();
    dropOverlay.style.pointerEvents = "none";
    dropzone.classList.remove("dragover");
  });
});

dropOverlay.addEventListener("drop", async (e) => {
  const files = [...e.dataTransfer.files];
  const geotiff = files.find(f => f.name.match(/\.(tif|tiff)$/i));

  if (!geotiff) {
    alert("GeoTIFF をドロップしてください");
    return;
  }

  console.log("GeoTIFF 読み込み開始:", geotiff.name);

  const arrayBuffer = await geotiff.arrayBuffer();
  await loadGeoTIFF(arrayBuffer, geotiff.name);
});

/* =========================
   5. geotiff.js による TIFF 読み込み
   ========================= */
async function loadGeoTIFF(arrayBuffer, name) {
  if (geotiffLayer) {
    map.removeLayer(geotiffLayer);
    layerControl.removeLayer(geotiffLayer);
  }

  const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
  const image = await tiff.getImage();
  const rasters = await image.readRasters();
  const width = image.getWidth();
  const height = image.getHeight();

  const tiepoints = image.getTiePoints();
  const fileDir = image.getFileDirectory();
  const pixelScale = fileDir.ModelPixelScale;
  const transform = fileDir.ModelTransformation;

  let xmin, xmax, ymin, ymax;

  if (transform) {
    xmin = transform[3];
    ymax = transform[7];
    xmax = xmin + transform[0] * width;
    ymin = ymax + transform[1] * height;
  } else if (tiepoints && tiepoints.length > 0 && pixelScale) {
    const tp = tiepoints[0];
    xmin = tp.x;
    ymax = tp.y;
    xmax = xmin + pixelScale[0] * width;
    ymin = ymax - pixelScale[1] * height;
  } else {
    alert("この GeoTIFF には位置情報がありません。表示できません。");
    return;
  }

  const bounds = [
    [ymin, xmin],
    [ymax, xmax]
  ];

  const canvas = L.imageOverlay(
    await rasterToDataURL(rasters, width, height),
    bounds,
    { opacity: 0.8 }
  );

  geotiffLayer = canvas;
  geotiffLayer.addTo(map);
  layerControl.addOverlay(geotiffLayer, `GeoTIFF: ${name}`);
  map.fitBounds(bounds);
}

/* =========================
   6. ラスター → PNG 変換
   ========================= */
async function rasterToDataURL(rasters, width, height) {
  const canvas = document.createElement("canvas");
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext("2d");
  const imgData = ctx.createImageData(width, height);

  for (let i = 0; i < width * height; i++) {
    imgData.data[i * 4 + 0] = rasters[0][i] || 0;
    imgData.data[i * 4 + 1] = rasters[1]?.[i] || rasters[0][i] || 0;
    imgData.data[i * 4 + 2] = rasters[2]?.[i] || rasters[0][i] || 0;
    imgData.data[i * 4 + 3] = 255;
  }

  ctx.putImageData(imgData, 0, 0);
  return canvas.toDataURL();
}

console.log("GeoTIFF ビューワー（geotiff.js版）準備完了");
</script>

</body>
</html>
